<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSPT1 - Strategic OT Planner </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-family-sans: 'Noto Sans Thai', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Tahoma', Arial, sans-serif;
            --background-main: #F7F8FA; --background-card: #FFFFFF; --text-primary: #1D2C3D;
            --text-secondary: #6A7280; --border-color: #EAECEF; --primary-color: #3A78C2;
            --primary-color-hover: #326AB1; --danger-color: #EF4444; --success-color: #10B981; --success-color-hover: #0DAA72;
            --info-color-bg: #EBF5FF; --info-color-text: #2563EB; --info-color-border: #93C5FD;
            --warning-color-bg: #FFFBEB; --warning-color-text: #B45309; --warning-color-border: #FBBF24;
            --radius-md: 10px; --radius-lg: 16px; --shadow-md: 0px 4px 6px -1px rgba(0, 0, 0, 0.05), 0px 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.2s;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-family-sans); margin: 0; padding: 24px; background-color: var(--background-main); color: var(--text-primary); -webkit-font-smoothing: antialiased; }
        .container { max-width: 1400px; margin: 20px auto; display: flex; flex-direction: column; gap: 28px; }
        .panel { background-color: var(--background-card); padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); transition: all var(--transition-speed) ease; }
        header { text-align: center; margin-bottom: 10px; }
        header h1 { font-size: 2.2em; font-weight: 700; margin: 0; color: var(--text-primary); }
        header p { color: var(--text-secondary); font-size: 1.15em; margin-top: 8px; }
        h2 { display: flex; justify-content: space-between; align-items: center; font-size: 1.6em; font-weight: 600; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        h3 { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; color: var(--text-secondary); }
        .btn { padding: 10px 18px; border-radius: var(--radius-md); border: 1px solid transparent; color: white; cursor: pointer; font-weight: 600; font-size: 0.95em; font-family: var(--font-family-sans); transition: all var(--transition-speed) ease; background-color: var(--primary-color); }
        .btn:hover { background-color: var(--primary-color-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(58, 120, 194, 0.2); }
        .btn:active { transform: translateY(0px); box-shadow: none; }
        .btn-small { padding: 6px 14px; font-size: 0.85em; }
        .btn-danger { background-color: #FEEEEE; color: var(--danger-color); border: 1px solid var(--danger-color);}
        .btn-danger:hover { background-color: var(--danger-color); color: white; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .btn-secondary { background-color: #F3F4F6; color: var(--text-secondary); border: 1px solid #D1D5DB;}
        .btn-secondary:hover { background-color: #E5E7EB; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: var(--success-color-hover); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        input[type="number"], select { width: 100%; padding: 10px 14px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: var(--radius-md); box-sizing: border-box; font-size: 15px; font-family: var(--font-family-sans); transition: all var(--transition-speed) ease; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(58, 120, 194, 0.1); }
        select[multiple] { width: 100%; min-height: 250px; border-radius: var(--radius-md); border-color: var(--border-color); padding: 10px; }
        .group-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .group-filters label { display: inline-flex; align-items: center; background-color: #F9FAFB; padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; transition: all var(--transition-speed); font-size: 0.9em; }
        .group-filters input[type="checkbox"] { display: none; }
        .group-filters input[type="checkbox"]:checked + span { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 500; }
        .budget-status { padding: 14px 18px; border-radius: var(--radius-md); text-align: center; font-weight: 600; margin-top: 20px; border: 1px solid transparent; font-size: 1.1em; transition: all var(--transition-speed) ease; }
        .budget-status.sufficient { background-color: #E6F6F0; color: #0F9A6C; border-color: #73D4B2; }
        .budget-status.over-budget { background-color: #FEEEEE; color: #EF4444; border-color: #F8A0A0; }
        .table-responsive-wrapper { width: 100%; overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--radius-lg); }
        .planning-table { width: 100%; border-collapse: collapse; }
        .planning-table th, .planning-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; white-space: nowrap; }
        .planning-table th { background-color: #F9FAFB; font-weight: 600; color: var(--text-secondary); font-size: 0.85em; text-transform: uppercase; padding: 14px; }
        .planning-table td:not(:first-child), .planning-table th:not(:first-child) { text-align: center; }
        .planning-table td:first-child, .planning-table th:first-child { text-align: left; }
        .planning-table tbody tr { transition: background-color var(--transition-speed) ease; }
        .planning-table tbody tr.row-highlight { background-color: #FFFBEB; }
        .planning-table tbody tr.holiday-shift { background-color: var(--warning-color-bg); }
        .planning-table tbody tr.holiday-shift td:first-child { border-left: 4px solid var(--warning-color-border); }
        .planning-table tbody tr.night-shift {
            background-image: linear-gradient(135deg, rgba(100, 116, 139, 0.05) 25%, transparent 25%, transparent 50%, rgba(100, 116, 139, 0.05) 50%, rgba(100, 116, 139, 0.05) 75%, transparent 75%, transparent);
            background-size: 28px 28px;
        }
        .planning-table .total-cost { color: var(--danger-color); font-weight: 700; }
        .planning-table input[type="number"], .planning-table select { margin-bottom: 0; padding: 8px; font-size: 14px; background-color: white; text-align: center; }
        .planning-table .ot-shifts, .planning-table .labor-count { width: 75px; }
        .planning-table .ot-type { width: 240px; text-align: left; }
        .action-cell { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .plan-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; transition: background-color var(--transition-speed) ease; }
        .plan-btn:hover { background-color: #eef2f5; }
        .plan-btn.remove-plan-btn:hover { background-color: #FEEEEE; }
        .plan-btn svg { transition: transform 0.2s ease; }
        .plan-btn:hover svg { transform: scale(1.1); }
        .placeholder-text { display: flex; flex-direction:column; align-items: center; justify-content: center; min-height: 200px; color: #9CA3AF; text-align: center; padding: 20px; border: 2px dashed var(--border-color); border-radius: var(--radius-lg); }
        .flex-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; }
        #auto-planner-results { margin-top: 25px; background-color: #F9FAFB; border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 25px; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
        #auto-planner-results.visible { opacity: 1; transform: translateY(0); }
        #auto-planner-results h3 { color: var(--success-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;}
        .recommendation-table .best-option { background-color: #E6F6F0; font-weight: 600; }
        .recommendation-table .best-option td:first-child::before { content: '⭐ '; }
        .info-box { background-color: var(--info-color-bg); color: var(--info-color-text); border-left: 5px solid var(--info-color-border); padding: 15px 20px; border-radius: var(--radius-md); margin-bottom: 25px; font-size: 0.95em; line-height: 1.6; }
        .info-note { font-size: 0.9em; color: var(--text-secondary); background-color: #F9FAFB; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px 18px; margin-bottom: 25px; text-align: center; }
        .info-note p { margin: 0; }
        .info-note strong { color: var(--text-primary); }
        .group-summary-container { margin-top: 25px; display: flex; flex-direction: column; gap: 20px;}
        .group-summary-block { border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px; }
        .group-summary-block h3 { margin-top:0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .summary-box { background-color: #F9FAFB; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 20px; }
        .summary-box h4 { margin-top: 0; margin-bottom: 15px; font-size: 1.05em;}
        .summary-box p { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1em; }
        .summary-box p span:last-child { font-weight: 600; }
        .summary-box .highlight-value { color: var(--primary-color); font-weight: 700; }
        .summary-box .success-value { color: var(--success-color); font-weight: 700; }
        .summary-box .danger-value { color: var(--danger-color); font-weight: 700; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible { opacity: 1; pointer-events: all; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--radius-lg); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; }
        .modal-options { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        .modal-options label { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .header-actions { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TSPT1 - Strategic OT Planner </h1>
            <p>เครื่องมือวางแผน OT อัจฉริยะ พร้อมระบบวิเคราะห์, ให้คำแนะนำเชิงกลยุทธ์, และจดจำการทำงานล่าสุด by  Chaiyapat.Cha</p>
        </header>

        <section class="panel">
            <h2>1. กำหนดเงื่อนไขภาพรวม (Global Settings)</h2>
            <div class="flex-grid">
                <div>
                    <h3>อัตราค่าจ้าง (บาท/ชั่วโมง) - แยกตามกลุ่ม</h3>
                    <div id="group-rate-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <!-- Group rate inputs will be dynamically inserted here -->
                    </div>
                </div>
                <div>
                    <h3>งบประมาณ (แยกตามกลุ่ม)</h3>
                    <div class="flex-grid" id="group-budget-container" style="gap: 15px;">
                        <!-- Group budget inputs will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </section>

        <section class="panel">
            <h2>2. เลือกเครื่องจักร (Machine Selection)</h2>
            <div class="info-box">
                <b>เคล็ดลับการวางแผน:</b> เลือกเครื่องจักรทั้งหมดที่คุณอาจจะต้องใช้ OT จากนั้นไปที่ข้อ 3 เพื่อกำหนด 'ทางเลือกเชิงกลยุทธ์' หรือ 'แผนย่อย' ที่หลากหลายสำหรับเครื่องจักรเหล่านั้น
            </div>
            <div class="flex-grid" style="align-items: flex-end;">
                <div style="flex-grow: 1;">
                    <label>กรองตามกลุ่มเครื่องจักร:</label>
                    <div id="group-filter-container" class="group-filters"></div>
                    <label for="machine-selector">เลือกเครื่องจักรที่ต้องการเพิ่มเข้าแผน:</label>
                    <select id="machine-selector" multiple></select>
                </div>
                <div>
                    <button id="add-machines-btn" class="btn" style="width: 100%;">+ เพิ่มเข้าสู่ตารางวางแผน</button>
                </div>
            </div>
        </section>
        
        <section class="panel">
            <h2 style="align-items: flex-start;">
                <span>3. สร้างทางเลือกเชิงกลยุทธ์ / แผนย่อย</span>
                <div class="header-actions">
                    <button id="export-png-btn" class="btn btn-secondary btn-small">Export สรุปเป็นรูปภาพ (PNG)</button>
                    <button id="export-plan-btn" class="btn btn-secondary btn-small">Export แผนพร้อมสรุป (Excel)</button>
                    <button id="clear-plan-btn" class="btn btn-danger btn-small">ล้างแผนทั้งหมด</button>
                </div>
            </h2>
            
            <div class="info-note">
                <p>
                    <strong>*หมายเหตุ (ชั่วโมง/กะ):</strong> 
                    OT ต่อเนื่อง (วันทำงาน-กลางวัน): <strong>2.5 ชม.</strong> | OT ต่อเนื่อง (วันทำงาน-คืน): <strong>2.5 ชม.</strong> | OT วันหยุด (กะกลางวัน): <strong>7.5 ชม.</strong> | OT วันหยุด (กะกลางคืน): <strong>7.08 ชม.</strong>
                </p>
            </div>

            <div id="planning-table-container"></div>
            <div id="plan-summary-container"></div>
            <div id="budget-status-container"></div>
        </section>
        
        <section class="panel" id="auto-planner-panel">
            <h2>4. วิเคราะห์หาชุดค่าผสมที่ดีที่สุด (Kaizen Optimizer)</h2>
            <div class="flex-grid" style="align-items: flex-end;">
                <div>
                    <label for="number-of-days">แผน OT นี้สำหรับกี่วัน?</label>
                    <input type="number" id="number-of-days" value="1" min="1">
                </div>
                <div>
                    <button id="run-optimizer-btn" class="btn btn-success" style="width:100%;">วิเคราะห์และหาทางเลือกในงบ</button>
                </div>
            </div>
            <div id="auto-planner-results"></div>
        </section>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA & CONSTANTS ---
        const OT_HOURS = { weekdayDay: 2.5, weekdayNight: 2.5, holidayDay: 7.5, holidayNight: 7.08 };
        const OT_TYPE_NAMES = { weekdayDay: 'OT ต่อเนื่อง (วันทำงาน-กลางวัน)', weekdayNight: 'OT ต่อเนื่อง (วันทำงาน-คืน)', holidayDay: 'OT วันหยุด (กะกลางวัน)', holidayNight: 'OT วันหยุด (กะกลางคืน)' };
        const machinesData = [
            {"id": "A1", "maker": "TOSHIBA", "model": "IS 650GT-59A"}, {"id": "A2", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A3", "maker": "JSW", "model": "J 650 EIIW-13A"}, {"id": "A4", "maker": "MITSUBISHI", "model": "650 MG-110"}, {"id": "A5", "maker": "TOSHIBA", "model": "IS 650EW-54A"}, {"id": "A6", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A9", "maker": "JSW", "model": "J450EII B"}, {"id": "A10", "maker": "JSW", "model": "J450EII B"}, {"id": "A11", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A12", "maker": "TOSHIBA", "model": "IS1300DGW-110A"}, {"id": "A13", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A14", "maker": "JSW", "model": "J 1300EWI6AC5"}, {"id": "A15", "maker": "TOSHIBA", "model": "IS 850EW-80A"}, {"id": "A16", "maker": "TOSHIBA", "model": "IS 850FA3W-81A"}, {"id": "A17", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A18", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "A19", "maker": "JSW", "model": "J 1300EWI6AC5"}, {"id": "A20", "maker": "TOSHIBA", "model": "IS1600DFW-150A"},
            {"id": "B4", "maker": "TOSHIBA", "model": "IS 150EN-5A"}, {"id": "B5", "maker": "TOSHIBA", "model": "IS170G-5A"}, {"id": "B6", "maker": "TOSHIBA", "model": "IS 170FA-5A"}, {"id": "B10", "maker": "AP", "model": "SM350"}, {"id": "B11", "maker": "TOSHIBA", "model": "IS 350FA3-27A"}, {"id": "B12", "maker": "TOSHIBA", "model": "IS 350GS-27A"}, {"id": "B13", "maker": "AP", "model": "SM350"}, {"id": "B15", "maker": "JSW", "model": "J 1300EIIW"}, {"id": "B18", "maker": "AP", "model": "SM350"},
            {"id": "D1", "maker": "MITSUBISHI", "model": "1300MMVW-240"}, {"id": "D2", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "D3", "maker": "MITSUBISHI", "model": "650 ME2-110"}, {"id": "D4", "maker": "AP", "model": "SM450"}, {"id": "D6", "maker": "TOSHIBA", "model": "IS 650GT-59A"}, {"id": "D7", "maker": "JSW", "model": "J 650 EIIW-13A"}, {"id": "D8", "maker": "TOSHIBA", "model": "IS 650GT-59A"}, {"id": "D9", "maker": "TOSHIBA", "model": "IS 850GTW-81A"}, {"id": "D10", "maker": "AP", "model": "SM350"}, {"id": "D11", "maker": "AP", "model": "SM350"}, {"id": "D12", "maker": "U-MHIPT", "model": "3000MMX-470"}, {"id": "D13", "maker": "U-MHIPT", "model": "3000MMX-470"},
            { "id": "A-ASSY", "maker": "WORKSTATION", "model": "Assembly Line A" }, { "id": "A-PACK", "maker": "WORKSTATION", "model": "Packing Station" }, { "id": "A-POLISH", "maker": "WORKSTATION", "model": "Polishing Station" }, { "id": "B-ASSY", "maker": "WORKSTATION", "model": "Assembly Line B" }, { "id": "D-ASSY", "maker": "WORKSTATION", "model": "Assembly Line D" }
        ].sort((a, b) => a.id.localeCompare(b.id));
        const KNOWN_GROUPS = ['A', 'B', 'D'];

        // --- STATE MANAGEMENT ---
        let otPlans = [];
        let optimizerResults = [];
        const APP_STORAGE_KEY = 'strategicOTPlannerState_v3';

        const saveState = () => {
            const state = {
                plans: otPlans,
                days: document.getElementById('number-of-days').value,
                groupBudgets: getGroupBudgetsFromUI(),
                groupRates: getGroupRatesFromUI()
            };
            localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state));
        };

        const loadState = () => {
            const savedState = localStorage.getItem(APP_STORAGE_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                otPlans = state.plans || [];
                document.getElementById('number-of-days').value = state.days || 1;
                if (state.groupBudgets) {
                    Object.keys(state.groupBudgets).forEach(group => {
                        const input = document.getElementById(`budget-group-${group}`);
                        if (input) input.value = state.groupBudgets[group];
                    });
                }
                if (state.groupRates) {
                    Object.keys(state.groupRates).forEach(group => {
                        const directInput = document.getElementById(`rate-direct-group-${group}`);
                        if (directInput) directInput.value = state.groupRates[group].direct;
                        const indirectInput = document.getElementById(`rate-indirect-group-${group}`);
                        if (indirectInput) indirectInput.value = state.groupRates[group].indirect;
                    });
                }
            }
        };

        const generatePlanId = () => `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // --- DOM ELEMENTS ---
        const groupFilterContainer = document.getElementById('group-filter-container');
        const machineSelector = document.getElementById('machine-selector');
        const planningTableContainer = document.getElementById('planning-table-container');
        const planSummaryContainer = document.getElementById('plan-summary-container');
        const budgetStatusContainer = document.getElementById('budget-status-container');
        const resultsContainer = document.getElementById('auto-planner-results');
        const groupBudgetContainer = document.getElementById('group-budget-container');
        const groupRateContainer = document.getElementById('group-rate-container');

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (num) => num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatNumber = (num) => num.toLocaleString('th-TH', { maximumFractionDigits: 2 });
        const getGroupBudgetsFromUI = () => {
            const budgets = {};
            document.querySelectorAll('.group-budget-input').forEach(input => {
                budgets[input.dataset.group] = parseFloat(input.value) || 0;
            });
            return budgets;
        };
        const getGroupRatesFromUI = () => {
            const rates = {};
            KNOWN_GROUPS.forEach(group => {
                rates[group] = {
                    direct: parseFloat(document.getElementById(`rate-direct-group-${group}`).value) || 0,
                    indirect: parseFloat(document.getElementById(`rate-indirect-group-${group}`).value) || 0
                };
            });
            return rates;
        };
        
        // --- CORE LOGIC ---
        const updateCalculationsAndTotals = () => {
            if (otPlans.length === 0) {
                planSummaryContainer.innerHTML = '';
                budgetStatusContainer.innerHTML = '';
                return;
            }
            const groupBudgets = getGroupBudgetsFromUI();
            const groupRates = getGroupRatesFromUI();
            
            let totalCostOfActivePlans = 0;
            const groupSummaries = {};

            otPlans.forEach(plan => {
                const group = plan.machineId.charAt(0);
                if (!groupSummaries[group]) {
                    groupSummaries[group] = {
                        day: { directManShifts: 0, indirectManShifts: 0, cost: 0, machines: new Set() },
                        night: { directManShifts: 0, indirectManShifts: 0, cost: 0, machines: new Set() },
                        totalCost: 0,
                        totalDirectManShifts: 0,
                        totalIndirectManShifts: 0
                    };
                }

                const rate = groupRates[group] || { direct: 0, indirect: 0 };
                const hoursPerShift = OT_HOURS[plan.otType];
                const planCost = hoursPerShift * plan.shifts * ((plan.directCount * rate.direct) + (plan.indirectCount * rate.indirect));
                const directManShifts = plan.directCount * plan.shifts;
                const indirectManShifts = plan.indirectCount * plan.shifts;
                
                totalCostOfActivePlans += planCost;
                groupSummaries[group].totalCost += planCost;
                groupSummaries[group].totalDirectManShifts += directManShifts;
                groupSummaries[group].totalIndirectManShifts += indirectManShifts;

                const shiftType = plan.otType.toLowerCase().includes('night') ? 'night' : 'day';
                groupSummaries[group][shiftType].directManShifts += directManShifts;
                groupSummaries[group][shiftType].indirectManShifts += indirectManShifts;
                groupSummaries[group][shiftType].cost += planCost;
                groupSummaries[group][shiftType].machines.add(plan.machineId);
            });
            
            let summaryHtml = '<div class="group-summary-container">';
            Object.keys(groupSummaries).sort().forEach(group => {
                const summary = groupSummaries[group];
                const budget = groupBudgets[group] || 0;
                const totalMachines = new Set([...summary.day.machines, ...summary.night.machines]);
                
                const totalCostPercent = budget > 0 ? (summary.totalCost / budget) * 100 : 0;
                const dayCostPercent = budget > 0 ? (summary.day.cost / budget) * 100 : 0;
                const nightCostPercent = budget > 0 ? (summary.night.cost / budget) * 100 : 0;

                const remainingForNight = budget - summary.day.cost;
                const finalGroupBalance = budget - summary.totalCost;

                summaryHtml += `
                    <div class="group-summary-block" data-summary-group="${group}">
                        <h3>สรุปภาพรวมกลุ่ม ${group}</h3>
                        <div class="summary-grid">
                            <div class="summary-box">
                                <h4>สรุปภาพรวมกลุ่ม</h4>
                                <p><span>จำนวนเครื่องจักร (รวม):</span> <span>${totalMachines.size} เครื่อง</span></p>
                                <p><span style="padding-left: 15px;">- กะกลางวัน:</span> <span>${summary.day.machines.size} เครื่อง</span></p>
                                <p><span style="padding-left: 15px;">- กะกลางคืน:</span> <span>${summary.night.machines.size} เครื่อง</span></p>
                                <p><span>พนง. ผลิต (Man-Shifts):</span> <span>${summary.totalDirectManShifts}</span></p>
                                <p><span>พนง. สนับสนุน (Man-Shifts):</span> <span>${summary.totalIndirectManShifts}</span></p>
                                <p><span>งบประมาณ (ใช้ไปรวม):</span> <span class="${summary.totalCost > budget ? 'danger-value' : 'highlight-value'}">${formatCurrency(summary.totalCost)} (${totalCostPercent.toFixed(2)}%)</span></p>
                            </div>
                            <div class="summary-box">
                                <h4>สรุปกะกลางวัน</h4>
                                <p><span>จำนวนเครื่องจักร (เปิด):</span> <span>${summary.day.machines.size} เครื่อง</span></p>
                                <p><span>ID เครื่องจักร:</span> <span style="font-weight: 400; font-size: 0.9em; word-break: break-all;">${Array.from(summary.day.machines).sort().join(', ') || '-'}</span></p>
                                <p><span>พนง. ผลิต (Man-Shifts):</span> <span>${summary.day.directManShifts}</span></p>
                                <p><span>พนง. สนับสนุน (Man-Shifts):</span> <span>${summary.day.indirectManShifts}</span></p>
                                <p><span>งบประมาณ (ใช้ไป):</span> <span class="highlight-value">${formatCurrency(summary.day.cost)} (${dayCostPercent.toFixed(2)}%)</span></p>
                                <p><span>งบประมาณคงเหลือ:</span> <span class="success-value">${formatCurrency(remainingForNight)} บาท</span></p>
                            </div>
                            <div class="summary-box">
                                <h4>สรุปกะกลางคืน</h4>
                                <p><span>จำนวนเครื่องจักร (เปิด):</span> <span>${summary.night.machines.size} เครื่อง</span></p>
                                <p><span>ID เครื่องจักร:</span> <span style="font-weight: 400; font-size: 0.9em; word-break: break-all;">${Array.from(summary.night.machines).sort().join(', ') || '-'}</span></p>
                                <p><span>พนง. ผลิต (Man-Shifts):</span> <span>${summary.night.directManShifts}</span></p>
                                <p><span>พนง. สนับสนุน (Man-Shifts):</span> <span>${summary.night.indirectManShifts}</span></p>
                                <p><span>งบประมาณ (ใช้ไป):</span> <span class="highlight-value">${formatCurrency(summary.night.cost)} (${nightCostPercent.toFixed(2)}%)</span></p>
                                <p><span>สถานะงบกลุ่ม (หลังรวม 2 กะ):</span> <span class="${finalGroupBalance < 0 ? 'danger-value' : 'success-value'}">${formatCurrency(finalGroupBalance)} บาท</span></p>
                            </div>
                        </div>
                    </div>`;
            });
            summaryHtml += '</div>';
            planSummaryContainer.innerHTML = summaryHtml;
            
            let activeGroupsTotalBudget = 0;
            const activeGroups = Object.keys(groupSummaries);
            activeGroups.forEach(group => {
                activeGroupsTotalBudget += groupBudgets[group] || 0;
            });

            const totalPercentage = (activeGroupsTotalBudget > 0) ? (totalCostOfActivePlans / activeGroupsTotalBudget) * 100 : 0;
            
            if (totalCostOfActivePlans > activeGroupsTotalBudget) {
                budgetStatusContainer.innerHTML = `<div class="budget-status over-budget"><strong>เกินงบประมาณกลุ่มที่ใช้!</strong> | ยอดรวม ${formatCurrency(totalCostOfActivePlans)} บาท (${totalPercentage.toFixed(2)}%)</div>`;
            } else {
                budgetStatusContainer.innerHTML = `<div class="budget-status sufficient"><strong>อยู่ในงบประมาณกลุ่มที่ใช้</strong> | ยอดรวม ${formatCurrency(totalCostOfActivePlans)} บาท (${totalPercentage.toFixed(2)}%)</div>`;
            }
            saveState();
        };

        const updateSingleRow = (planId) => {
            const row = planningTableContainer.querySelector(`tr[data-plan-id="${planId}"]`);
            if (!row) return;
            const plan = otPlans.find(p => p.planId === planId);
            const groupRates = getGroupRatesFromUI();
            const group = plan.machineId.charAt(0);
            const rate = groupRates[group] || { direct: 0, indirect: 0 };
            
            const hoursPerShift = OT_HOURS[plan.otType];
            const planTotalHours = hoursPerShift * plan.shifts;
            const planTotalCost = planTotalHours * ((plan.directCount * rate.direct) + (plan.indirectCount * rate.indirect));
            
            row.cells[5].textContent = formatNumber(planTotalHours);
            row.cells[6].textContent = formatCurrency(planTotalCost);
            
            row.classList.add('row-highlight');
            setTimeout(() => row.classList.remove('row-highlight'), 1500);

            updateCalculationsAndTotals();
        };

        // --- RENDERING ---
        const renderPlanningTable = () => {
            if (otPlans.length === 0) {
                planningTableContainer.innerHTML = `<div class="placeholder-text"><p><b>ยังไม่มีแผนย่อยในขณะนี้</b></p><p style="max-width: 600px;">กรุณาเลือกเครื่องจักรในข้อ 2 และกดปุ่ม "+ เพิ่มเข้าสู่ตารางวางแผน" เพื่อเริ่มต้น</p></div>`;
                updateCalculationsAndTotals();
                saveState();
                return;
            }
            const tableBody = planningTableContainer.querySelector('tbody');
            if(tableBody) {
                Array.from(tableBody.rows).forEach(row => {
                    if (!otPlans.some(p => p.planId === row.dataset.planId)) {
                        row.remove();
                    }
                });
                otPlans.forEach((plan, index) => {
                    let row = tableBody.querySelector(`tr[data-plan-id="${plan.planId}"]`);
                    if(!row) {
                        row = document.createElement('tr');
                        row.dataset.planId = plan.planId;
                        
                        const isHoliday = plan.otType.includes('holiday');
                        const isNight = plan.otType.toLowerCase().includes('night');
                        if (isHoliday) row.classList.add('holiday-shift');
                        if (isNight) row.classList.add('night-shift');

                        row.innerHTML = createRowHtml(plan);
                        const previousPlanId = index > 0 ? otPlans[index - 1].planId : null;
                        const previousRow = previousPlanId ? tableBody.querySelector(`tr[data-plan-id="${previousPlanId}"]`) : null;
                        if(previousRow) {
                            previousRow.after(row);
                        } else {
                            tableBody.prepend(row);
                        }
                    }
                });
            } else {
                 planningTableContainer.innerHTML = createTableShell(otPlans);
            }
            otPlans.forEach(plan => updateSingleRow(plan.planId));
        };

        const createRowHtml = (plan) => {
            const machine = machinesData.find(m => m.id === plan.machineId);
            return `
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <strong>${machine.id}</strong>
                        <button class="plan-btn add-plan-btn" data-machine-id="${machine.id}" title="เพิ่มแผนย่อยสำหรับ ${machine.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                </td>
                <td><select class="ot-type" data-plan-id="${plan.planId}">
                    ${Object.entries(OT_TYPE_NAMES).map(([key, name]) => `<option value="${key}" ${plan.otType === key ? 'selected' : ''}>${name}</option>`).join('')}
                </select></td>
                <td><input type="number" class="ot-shifts" value="${plan.shifts}" min="0" data-plan-id="${plan.planId}"></td>
                <td><input type="number" class="labor-count" value="${plan.directCount}" min="0" data-plan-id="${plan.planId}" data-labor-type="direct"></td>
                <td><input type="number" class="labor-count" value="${plan.indirectCount}" min="0" data-plan-id="${plan.planId}" data-labor-type="indirect"></td>
                <td>0.00</td>
                <td class="total-cost">0.00</td>
                <td><div class="action-cell">
                    <button class="plan-btn duplicate-plan-btn" data-plan-id="${plan.planId}" title="ทำซ้ำแผนย่อยนี้">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6A7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                    <button class="plan-btn remove-plan-btn" data-plan-id="${plan.planId}" title="ลบแผนย่อยนี้">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E53E3E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div></td>`;
        };
        
        const createTableShell = (plans) => {
            const tableRows = plans.map(p => {
                const isHoliday = p.otType.includes('holiday');
                const isNight = p.otType.toLowerCase().includes('night');
                let classes = [];
                if (isHoliday) classes.push('holiday-shift');
                if (isNight) classes.push('night-shift');
                return `<tr data-plan-id="${p.planId}" class="${classes.join(' ')}">${createRowHtml(p)}</tr>`;
            }).join('');

            return `
            <div class="table-responsive-wrapper">
                <table class="planning-table">
                    <thead><tr>
                        <th>ID เครื่องจักร</th><th>ประเภทแผนย่อย (OT Type)</th><th>จำนวนกะ</th><th>พนง.ผลิต(คน)</th><th>พนง.สนับสนุน(คน)</th><th>ชม. OT</th><th>ค่าใช้จ่าย(บาท)</th><th>จัดการ</th>
                    </tr></thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>`;
        };
        // --- OPTIMIZER LOGIC ---
        const runBudgetOptimizer = () => {
            resultsContainer.classList.remove('visible');

            if (otPlans.length > 20) {
                alert(`คำเตือน: จำนวนแผนย่อย (${otPlans.length}) มีมากเกินไป อาจทำให้เบราว์เซอร์ทำงานช้าหรือค้างได้\n\nโปรดลดจำนวนแผนย่อยให้เหลือน้อยกว่า 20 แผนก่อนทำการวิเคราะห์`);
                return;
            }

            const groupBudgets = getGroupBudgetsFromUI();
            const groupRates = getGroupRatesFromUI();
            const numberOfDays = parseInt(document.getElementById('number-of-days').value, 10) || 1;
            const dailyGroupBudgets = {};
            Object.keys(groupBudgets).forEach(group => {
                dailyGroupBudgets[group] = groupBudgets[group] / numberOfDays;
            });
            
            if (otPlans.length === 0) {
                 resultsContainer.innerHTML = '<h3>ผลการวิเคราะห์</h3><p style="color:var(--danger-color)">กรุณาสร้าง "แผนย่อย" ในข้อ 3 ก่อน</p>';
                 setTimeout(() => resultsContainer.classList.add('visible'), 50);
                 return;
            }

            const getPowerSet = array => array.reduce((subsets, value) => subsets.concat(subsets.map(set => [value, ...set])),[[]]);
            const allCombinations = getPowerSet(otPlans).filter(s => s.length > 0);
            
            let potentialRecommendations = allCombinations.map(scenarioPlan => {
                const scenarioGroupCosts = {};
                let scenarioTotalCost = 0, scenarioTotalDirectManShifts = 0, scenarioTotalIndirectManShifts = 0;
                
                // --- LOGIC TO SEPARATE PLANS AND MAN-SHIFTS BY SHIFT (DAY/NIGHT) ---
                let dayIndirectManShifts = 0, nightIndirectManShifts = 0;
                const dayPlans = scenarioPlan.filter(p => !p.otType.toLowerCase().includes('night'));
                const nightPlans = scenarioPlan.filter(p => p.otType.toLowerCase().includes('night'));

                scenarioPlan.forEach(p => {
                    const group = p.machineId.charAt(0);
                    if (!scenarioGroupCosts[group]) scenarioGroupCosts[group] = 0;
                    
                    const rate = groupRates[group] || { direct: 0, indirect: 0 };
                    const hoursPerShift = OT_HOURS[p.otType];
                    const cost = hoursPerShift * p.shifts * ((p.directCount * rate.direct) + (p.indirectCount * rate.indirect));
                    
                    scenarioGroupCosts[group] += cost;
                    scenarioTotalCost += cost;
                    scenarioTotalDirectManShifts += p.directCount * p.shifts;
                    
                    const currentIndirectManShifts = p.indirectCount * p.shifts;
                    scenarioTotalIndirectManShifts += currentIndirectManShifts;

                    // Accumulate indirect man-shifts separately for each shift
                    if (p.otType.toLowerCase().includes('night')) {
                        nightIndirectManShifts += currentIndirectManShifts;
                    } else {
                        dayIndirectManShifts += currentIndirectManShifts;
                    }
                });
                
                let isWithinAllBudgets = true;
                for(const group in scenarioGroupCosts) {
                    const groupBudget = dailyGroupBudgets[group] !== undefined ? dailyGroupBudgets[group] : Infinity;
                    if (scenarioGroupCosts[group] > groupBudget) {
                        isWithinAllBudgets = false;
                        break;
                    }
                }

                // --- LOGIC TO VALIDATE EACH SHIFT INDEPENDENTLY ---
                
                // Validate Day Shift Separately
                const numUniqueDayMachines = new Set(dayPlans.map(p => p.machineId)).size;
                let isDayScenarioValid = false;
                if (numUniqueDayMachines === 0) {
                    isDayScenarioValid = true; // No day plans, so it's valid by default
                } else if (numUniqueDayMachines < 3) {
                    isDayScenarioValid = true; 
                } else if (numUniqueDayMachines >= 3 && numUniqueDayMachines <= 5) {
                    if (dayIndirectManShifts === 1) isDayScenarioValid = true;
                } else if (numUniqueDayMachines > 5) {
                    if (dayIndirectManShifts === 2 || dayIndirectManShifts === 3) isDayScenarioValid = true;
                }

                // Validate Night Shift Separately
                const numUniqueNightMachines = new Set(nightPlans.map(p => p.machineId)).size;
                let isNightScenarioValid = false;
                 if (numUniqueNightMachines === 0) {
                    isNightScenarioValid = true; // No night plans, so it's valid by default
                } else if (numUniqueNightMachines < 3) {
                    isNightScenarioValid = true; 
                } else if (numUniqueNightMachines >= 3 && numUniqueNightMachines <= 5) {
                    if (nightIndirectManShifts === 1) isNightScenarioValid = true;
                } else if (numUniqueNightMachines > 5) {
                    if (nightIndirectManShifts === 2 || nightIndirectManShifts === 3) isNightScenarioValid = true;
                }
                
                // The entire scenario is only valid if BOTH shifts meet their independent criteria
                const isScenarioValid = isDayScenarioValid && isNightScenarioValid;
                
                if (isScenarioValid && isWithinAllBudgets) {
                    let scenarioSpecificDailyBudget = 0;
                    const scenarioGroups = Object.keys(scenarioGroupCosts);
                    scenarioGroups.forEach(group => {
                        if(dailyGroupBudgets[group]) {
                            scenarioSpecificDailyBudget += dailyGroupBudgets[group];
                        }
                    });

                    return {
                        machines: new Set(scenarioPlan.map(p => p.machineId)).size, 
                        machineList: scenarioPlan.map(p => p.machineId).sort().join(', '),
                        direct: scenarioTotalDirectManShifts, 
                        indirect: scenarioTotalIndirectManShifts,
                        dailyCost: scenarioTotalCost,
                        scenarioBudget: scenarioSpecificDailyBudget,
                        planDetails: scenarioPlan
                    };
                }
                return null;
            }).filter(Boolean);

            const sortedRecommendations = potentialRecommendations.sort((a, b) => a.dailyCost - b.dailyCost);
            
            if (sortedRecommendations.length > 10) {
                let selected = new Set();
                selected.add(sortedRecommendations[0]); 
                selected.add(sortedRecommendations[sortedRecommendations.length - 1]); 

                const totalItems = sortedRecommendations.length;
                const remainingSlots = 10 - selected.size; 
                
                const interval = (totalItems - 1) / (remainingSlots + 1);

                for (let i = 1; i <= remainingSlots; i++) {
                    const index = Math.round(i * interval);
                    if (index > 0 && index < totalItems - 1) {
                         selected.add(sortedRecommendations[index]);
                    }
                }
                
                optimizerResults = Array.from(selected).sort((a, b) => a.dailyCost - b.dailyCost);

            } else {
                optimizerResults = sortedRecommendations;
            }
            
            let resultsHTML = `
                <h3>
                    <span>ผลการวิเคราะห์ชุดค่าผสม (Combinations Analysis)</span>
                    <button id="export-optimizer-btn" class="btn btn-secondary btn-small">Export เป็น Action Plan</button>
                </h3>`;
            
            if (optimizerResults.length > 0) {
                 resultsHTML += `<p>พบ ${potentialRecommendations.length} ทางเลือกที่เป็นไปได้ | แสดงผล ${optimizerResults.length} ทางเลือกที่หลากหลายและอยู่ในงบประมาณของแต่ละกลุ่ม</p>
                 <div class="table-responsive-wrapper">
                    <table class="planning-table recommendation-table">
                        <thead><tr><th>ทางเลือก</th><th>จำนวนเครื่อง</th><th>พนง. ผลิต / สนับสนุน</th><th>ค่าใช้จ่าย/วัน (บาท)</th><th>สัดส่วนงบกลุ่มที่ใช้</th></tr></thead>
                        <tbody>`;
                optimizerResults.forEach((rec, index) => {
                    const isBest = rec === sortedRecommendations[sortedRecommendations.length - 1];
                    const budgetPercentage = (rec.scenarioBudget > 0) ? (rec.dailyCost / rec.scenarioBudget) * 100 : 0;
                    resultsHTML += `
                        <tr class="${isBest ? 'best-option' : ''}">
                            <td>${isBest ? 'ดีที่สุด (คุ้มค่างบสุด)' : `ทางเลือก ${index + 1}`}</td>
                            <td title="เครื่องจักร: ${rec.machineList}">${rec.machines}</td>
                            <td>${rec.direct} / ${rec.indirect}</td>
                            <td class="total-cost">${formatCurrency(rec.dailyCost)}</td>
                            <td>${budgetPercentage.toFixed(2)}%</td>
                        </tr>`;
                });
                resultsHTML += `</tbody></table></div>`;
            } else {
                 resultsHTML += `<p style="color:var(--danger-color);">ไม่พบชุดค่าผสมของแผนย่อยที่สามารถทำได้ภายใต้งบประมาณและเงื่อนไขพนักงานสนับสนุนของทุกกลุ่มที่กำหนด</p>
                <div class="info-box" style="margin-top:15px; background-color: var(--warning-color-bg); color: var(--warning-color-text); border-left-color: var(--warning-color-border);"><b>ข้อแนะนำ (Kaizen):</b> ลองเพิ่มงบประมาณ, ปรับลดจำนวนคน/กะ, หรือเพิ่ม/แก้ไขแผนย่อยให้สอดคล้องกับเงื่อนไขพนักงานสนับสนุน (เช่น กะที่มีเครื่องจักร 3-5 เครื่อง ควรมี พนง.สนับสนุน 1 คน) เพื่อให้ระบบหาทางเลือกได้มากขึ้น</div>`;
            }
            
            resultsContainer.innerHTML = resultsHTML;
            setTimeout(() => resultsContainer.classList.add('visible'), 50);
        };

        // --- EVENT HANDLERS & INITIALIZATION ---
        const initEventListeners = () => {
            document.getElementById('number-of-days').addEventListener('input', updateCalculationsAndTotals);
            groupBudgetContainer.addEventListener('input', (e) => {
                if(e.target.classList.contains('group-budget-input')) {                    updateCalculationsAndTotals();
                }
            });
            groupRateContainer.addEventListener('input', (e) => {
                if(e.target.classList.contains('group-rate-input')) {
                    otPlans.forEach(plan => updateSingleRow(plan.planId));
                }
            });

            groupFilterContainer.addEventListener('change', () => {
                const selectedGroups = Array.from(document.querySelectorAll('input[name="group-filter"]:checked')).map(cb => cb.value);
                const machinesToDisplay = (selectedGroups.length === 0) ? machinesData : machinesData.filter(m => selectedGroups.includes(m.id.charAt(0)));
                machineSelector.innerHTML = machinesToDisplay.map(m => `<option value="${m.id}">${m.id} - ${m.maker} (${m.model})</option>`).join('');
            });
            document.getElementById('add-machines-btn').addEventListener('click', () => {
                Array.from(machineSelector.selectedOptions).map(opt => opt.value).forEach(id => {
                    if (!otPlans.some(p => p.machineId === id)) {
                        otPlans.push({ planId: generatePlanId(), machineId: id, otType: 'weekdayDay', shifts: 1, directCount: 1, indirectCount: 0 });
                    }
                });
                renderPlanningTable();
            });

            document.getElementById('clear-plan-btn').addEventListener('click', () => {
                if (confirm('คุณต้องการล้างแผนทั้งหมดที่สร้างไว้ใช่หรือไม่? (ข้อมูลจะถูกลบถาวร)')) {
                    otPlans = [];
                    resultsContainer.classList.remove('visible');
                    renderPlanningTable();
                }
            });
            document.getElementById('export-plan-btn').addEventListener('click', exportSection3ToExcel);
            document.getElementById('export-png-btn').addEventListener('click', showGroupSelectionModal);

            planningTableContainer.addEventListener('input', e => {
                const target = e.target;
                const planId = target.closest('tr')?.dataset.planId;
                if (!planId) return;
                const plan = otPlans.find(p => p.planId === planId);
                if (!plan) return;

                if (target.matches('.ot-type')) {
                    plan.otType = target.value;
                    const row = target.closest('tr');
                    if (row) {
                        row.classList.toggle('holiday-shift', plan.otType.includes('holiday'));
                        row.classList.toggle('night-shift', plan.otType.toLowerCase().includes('night'));
                    }
                }
                else if (target.matches('.ot-shifts')) plan.shifts = parseInt(target.value, 10) || 0;
                else if (target.matches('.labor-count')) {
                    const laborType = target.dataset.laborType;
                    const value = parseInt(target.value, 10) || 0;
                    if (laborType === 'direct') plan.directCount = value;
                    else if (laborType === 'indirect') plan.indirectCount = value;
                }
                updateSingleRow(planId);
            });

            planningTableContainer.addEventListener('click', e => {
                const target = e.target.closest('.plan-btn');
                if (!target) return;
                const planId = target.closest('tr')?.dataset.planId;
                if (!planId) return;
                const planIndex = otPlans.findIndex(p => p.planId === planId);
                
                if (target.classList.contains('add-plan-btn')) {
                    const machineId = otPlans[planIndex].machineId;
                    const newPlan = { planId: generatePlanId(), machineId, otType: 'weekdayDay', shifts: 1, directCount: 1, indirectCount: 0 };
                    otPlans.splice(planIndex + 1, 0, newPlan);
                    renderPlanningTable();
                } else if (target.classList.contains('duplicate-plan-btn')) {
                    const originalPlan = otPlans[planIndex];
                    const duplicatedPlan = { ...originalPlan, planId: generatePlanId() };
                    otPlans.splice(planIndex + 1, 0, duplicatedPlan);
                    renderPlanningTable();
                } else if (target.classList.contains('remove-plan-btn')) {
                    otPlans = otPlans.filter(p => p.planId !== planId);
                    renderPlanningTable();
                }
            });

            document.getElementById('run-optimizer-btn').addEventListener('click', runBudgetOptimizer);
            
            resultsContainer.addEventListener('click', e => {
                 if (e.target && e.target.id === 'export-optimizer-btn') { 
                     exportSection4ToExcel(); 
                 }
            });
        };

        const initApp = () => {
            KNOWN_GROUPS.forEach(group => {
                groupBudgetContainer.innerHTML += `
                    <div>
                        <label for="budget-group-${group}">งบกลุ่ม ${group}</label>
                        <input type="number" id="budget-group-${group}" data-group="${group}" class="group-budget-input" value="10000" min="0">
                    </div>`;
                groupRateContainer.innerHTML += `
                    <div>
                         <label>กลุ่ม ${group} (ผลิต)</label>
                         <input type="number" id="rate-direct-group-${group}" class="group-rate-input" data-group="${group}" data-type="direct" value="${group === 'A' ? 75 : (group === 'B' ? 78 : 80)}">
                    </div>
                    <div>
                         <label>กลุ่ม ${group} (สนับสนุน)</label>
                         <input type="number" id="rate-indirect-group-${group}" class="group-rate-input" data-group="${group}" data-type="indirect" value="${group === 'A' ? 96 : (group === 'B' ? 98 : 100)}">
                    </div>
                `;
            });
            [...new Set(machinesData.map(m => m.id.charAt(0)))].sort().forEach(group => {
                groupFilterContainer.innerHTML += `<label><input type="checkbox" name="group-filter" value="${group}"><span class="group-filter-btn">กลุ่ม ${group}</span></label>`;
            });
            groupFilterContainer.dispatchEvent(new Event('change'));
            loadState();
            renderPlanningTable();
            initEventListeners();
        };
        // --- EXPORT & MODAL FUNCTIONS ---
        const exportCommon = (data, fileName, sheetName) => {
            try {
                if (data.length === 0) {
                    alert('ไม่มีข้อมูลสำหรับ Export');
                    return;
                }
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                XLSX.writeFile(workbook, `${fileName}_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch (error) {
                console.error("Excel Export failed:", error);
                alert("เกิดข้อผิดพลาดในการสร้างไฟล์ Excel กรุณาลองใหม่อีกครั้ง");
            }
        };
        
        const exportSection3ToExcel = () => {
            if (otPlans.length === 0) { alert('ไม่มี "แผนย่อย" สำหรับ Export'); return; }
            const groupBudgets = getGroupBudgetsFromUI();
            const groupRates = getGroupRatesFromUI();
            
            let grandTotalCost = 0;
            const groupSummaries = {};
            
            const data = otPlans.map(plan => {
                const group = plan.machineId.charAt(0);
                 if (!groupSummaries[group]) {
                    groupSummaries[group] = {
                        day: { directManShifts: 0, indirectManShifts: 0, cost: 0, machines: new Set() },
                        night: { directManShifts: 0, indirectManShifts: 0, cost: 0, machines: new Set() },
                        totalCost: 0, totalDirectManShifts: 0, totalIndirectManShifts: 0
                    };
                }
                const rate = groupRates[group] || { direct: 0, indirect: 0 };
                const hoursPerShift = OT_HOURS[plan.otType];
                const planTotalCost = hoursPerShift * plan.shifts * ((plan.directCount * rate.direct) + (plan.indirectCount * rate.indirect));
                const directManShifts = plan.directCount * plan.shifts;
                const indirectManShifts = plan.indirectCount * plan.shifts;
                grandTotalCost += planTotalCost;
                groupSummaries[group].totalCost += planTotalCost;
                groupSummaries[group].totalDirectManShifts += directManShifts;
                groupSummaries[group].totalIndirectManShifts += indirectManShifts;

                const shiftType = plan.otType.toLowerCase().includes('night') ? 'night' : 'day';
                groupSummaries[group][shiftType].directManShifts += directManShifts;
                groupSummaries[group][shiftType].indirectManShifts += indirectManShifts;
                groupSummaries[group][shiftType].cost += planTotalCost;
                groupSummaries[group][shiftType].machines.add(plan.machineId);

                return {
                    'ID เครื่องจักร': plan.machineId, 'ประเภทแผนย่อย': OT_TYPE_NAMES[plan.otType], 'จำนวนกะ': plan.shifts,
                    'พนง.ผลิต': plan.directCount, 'พนง.สนับสนุน': plan.indirectCount, 'ค่าใช้จ่าย (บาท)': planTotalCost
                };
            });

            data.push({}); 
            data.push({ 'ID เครื่องจักร': '--- สรุปภาพรวมแยกตามกลุ่ม (Group Summary) ---' });
            Object.keys(groupSummaries).sort().forEach(group => {
                const summary = groupSummaries[group];
                const budget = groupBudgets[group] || 0;
                const totalMachines = new Set([...summary.day.machines, ...summary.night.machines]);
                const totalCostPercent = budget > 0 ? (summary.totalCost / budget * 100).toFixed(2) + '%' : 'N/A';
                
                data.push({ 'ID เครื่องจักร': `สรุปกลุ่ม ${group}` });
                data.push({ 'ID เครื่องจักร': '  จำนวนเครื่องจักร (รวม)', 'ค่าใช้จ่าย (บาท)': totalMachines.size });
                data.push({ 'ID เครื่องจักร': '    - กะกลางวัน', 'ค่าใช้จ่าย (บาท)': summary.day.machines.size });
                data.push({ 'ID เครื่องจักร': '    - กะกลางคืน', 'ค่าใช้จ่าย (บาท)': summary.night.machines.size });
                data.push({ 'ID เครื่องจักร': '  พนง.ผลิต (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.totalDirectManShifts });
                data.push({ 'ID เครื่องจักร': '  พนง.สนับสนุน (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.totalIndirectManShifts });
                data.push({ 'ID เครื่องจักร': '  ค่าใช้จ่ายรวม (บาท)', 'ค่าใช้จ่าย (บาท)': summary.totalCost });
                data.push({ 'ID เครื่องจักร': '  สัดส่วนใช้งบกลุ่ม', 'ค่าใช้จ่าย (บาท)': totalCostPercent });
                data.push({ 'ID เครื่องจักร': '  เพดานงบ (บาท)', 'ค่าใช้จ่าย (บาท)': budget });
                data.push({});
                
                const dayCostPercent = budget > 0 ? (summary.day.cost / budget * 100).toFixed(2) + '%' : 'N/A';
                const remainingForNight = budget - summary.day.cost;
                data.push({ 'ID เครื่องจักร': '  -- กะกลางวัน --' });
                data.push({ 'ID เครื่องจักร': '    จำนวนเครื่องจักร (เปิด)', 'ค่าใช้จ่าย (บาท)': summary.day.machines.size });
                data.push({ 'ID เครื่องจักร': '      ID เครื่องจักร', 'ค่าใช้จ่าย (บาท)': Array.from(summary.day.machines).sort().join(', ') });
                data.push({ 'ID เครื่องจักร': '    พนง.ผลิต (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.day.directManShifts });
                data.push({ 'ID เครื่องจักร': '    พนง.สนับสนุน (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.day.indirectManShifts });
                data.push({ 'ID เครื่องจักร': '    ค่าใช้จ่ายกะ (บาท)', 'ค่าใช้จ่าย (บาท)': summary.day.cost });
                data.push({ 'ID เครื่องจักร': '    สัดส่วนใช้งบกลุ่ม', 'ค่าใช้จ่าย (บาท)': dayCostPercent });
                data.push({ 'ID เครื่องจักร': '    งบคงเหลือให้กะคืน', 'ค่าใช้จ่าย (บาท)': remainingForNight });
                data.push({});

                const nightCostPercent = budget > 0 ? (summary.night.cost / budget * 100).toFixed(2) + '%' : 'N/A';
                const finalGroupBalance = budget - summary.totalCost;
                data.push({ 'ID เครื่องจักร': '  -- กะกลางคืน --' });
                data.push({ 'ID เครื่องจักร': '    จำนวนเครื่องจักร (เปิด)', 'ค่าใช้จ่าย (บาท)': summary.night.machines.size });
                data.push({ 'ID เครื่องจักร': '      ID เครื่องจักร', 'ค่าใช้จ่าย (บาท)': Array.from(summary.night.machines).sort().join(', ') });
                data.push({ 'ID เครื่องจักร': '    พนง.ผลิต (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.night.directManShifts });
                data.push({ 'ID เครื่องจักร': '    พนง.สนับสนุน (Man-Shifts)', 'ค่าใช้จ่าย (บาท)': summary.night.indirectManShifts });
                data.push({ 'ID เครื่องจักร': '    ค่าใช้จ่ายกะ (บาท)', 'ค่าใช้จ่าย (บาท)': summary.night.cost });
                data.push({ 'ID เครื่องจักร': '    สัดส่วนใช้งบกลุ่ม', 'ค่าใช้จ่าย (บาท)': nightCostPercent });
                data.push({ 'ID เครื่องจักร': '    สถานะงบกลุ่มสุดท้าย', 'ค่าใช้จ่าย (บาท)': finalGroupBalance });
                data.push({}); 
            });

            let activeGroupsTotalBudget = 0;
            const activeGroups = Object.keys(groupSummaries);
            activeGroups.forEach(group => {
                activeGroupsTotalBudget += groupBudgets[group] || 0;
            });

            data.push({ 'ID เครื่องจักร': '--- สรุปงบประมาณกลุ่มที่ใช้ (Active Group Budget Summary) ---' });
            data.push({ 'ID เครื่องจักร': 'ยอดรวมค่าใช้จ่ายทั้งหมด (บาท)', 'ค่าใช้จ่าย (บาท)': grandTotalCost });
            data.push({ 'ID เครื่องจักร': 'เพดานงบประมาณกลุ่มที่ใช้ (บาท)', 'ค่าใช้จ่าย (บาท)': activeGroupsTotalBudget });
            const totalDifference = activeGroupsTotalBudget - grandTotalCost;
            const totalPercentage = activeGroupsTotalBudget > 0 ? (grandTotalCost / activeGroupsTotalBudget * 100).toFixed(2) + '%' : 'N/A';
            data.push({ 'ID เครื่องจักร': 'ส่วนต่างรวม', 'ค่าใช้จ่าย (บาท)': totalDifference });
            data.push({ 'ID เครื่องจักร': 'สัดส่วนการใช้งบ', 'ค่าใช้จ่าย (บาท)': totalPercentage });

            exportCommon(data, "Strategic_OT_Options_Summary", "Strategic Options");
        };

        const exportSection4ToExcel = () => {
            if (optimizerResults.length === 0) { alert('ไม่มีผลการวิเคราะห์สำหรับ Export'); return; }
            
            let exportData = [];
            const sortedByBest = [...optimizerResults].sort((a,b) => b.dailyCost - a.dailyCost);
            
            optimizerResults.forEach((rec, index) => {
                const isBest = rec.dailyCost === sortedByBest[0].dailyCost;
                const optionTitle = isBest ? `⭐ ทางเลือกที่ดีที่สุด (ใช้งบประมาณคุ้มค่าที่สุด)` : `ทางเลือกที่ ${index + 1}`;
                
                exportData.push({ 'ทางเลือก / เครื่องจักร': optionTitle });
                exportData.push({ 
                    'ทางเลือก / เครื่องจักร': 'ID เครื่องจักร',
                    'ประเภท OT': 'ประเภท OT',
                    'กะ': 'กะ',
                    'พนง.ผลิต': 'พนง.ผลิต',
                    'พนง.สนับสนุน': 'พนง.สนับสนุน'
                });

                rec.planDetails.sort((a,b) => a.machineId.localeCompare(b.machineId)).forEach(p => {
                    exportData.push({
                        'ทางเลือก / เครื่องจักร': p.machineId,
                        'ประเภท OT': OT_TYPE_NAMES[p.otType],
                        'กะ': p.otType.toLowerCase().includes('night') ? 'กลางคืน' : 'กลางวัน',
                        'พนง.ผลิต': p.directCount,
                        'พนง.สนับสนุน': p.indirectCount
                    });
                });
                
                const budgetPercentage = (rec.scenarioBudget > 0) ? (rec.dailyCost / rec.scenarioBudget) * 100 : 0;
                exportData.push({
                    'ทางเลือก / เครื่องจักร': 'สรุป:',
                    'ประเภท OT': `เครื่องจักร ${rec.machines} เครื่อง`,
                    'กะ': `ผลิต ${rec.direct} | สนับสนุน ${rec.indirect} (Man-Shifts)`,
                    'พนง.ผลิต': `ค่าใช้จ่าย ${formatCurrency(rec.dailyCost)} บาท/วัน`,
                    'พนง.สนับสนุน': `(${budgetPercentage.toFixed(2)}% ของงบกลุ่มที่ใช้)`
                });
                exportData.push({});
            });
            exportCommon(exportData, "OT_Action_Plan_Analysis", "Optimizer Action Plan");
        };

        const showGroupSelectionModal = () => {
            const existingModal = document.getElementById('png-export-modal');
            if (existingModal) existingModal.remove();

            const activeGroups = [...new Set(otPlans.map(p => p.machineId.charAt(0)))].sort();
            if (activeGroups.length === 0) {
                alert('ยังไม่มีแผนในตารางสำหรับ Export');
                return;
            }

            const modalBackdrop = document.createElement('div');
            modalBackdrop.className = 'modal-backdrop';
            modalBackdrop.id = 'png-export-modal';
            modalBackdrop.innerHTML = `
                <div class="modal-content">
                    <h3>เลือกกลุ่มที่ต้องการ Export</h3>
                    <div class="modal-options">
                        <label>
                            <input type="checkbox" id="select-all-groups" checked>
                            <strong>เลือกทั้งหมด</strong>
                        </label>
                        ${activeGroups.map(g => `
                            <label>
                                <input type="checkbox" class="group-select-checkbox" value="${g}" checked>
                                <span>กลุ่ม ${g}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="modal-actions">
                        <button id="cancel-export" class="btn btn-secondary">ยกเลิก</button>
                        <button id="confirm-export" class="btn btn-success">ยืนยันและ Export</button>
                    </div>
                </div>`;
            document.body.appendChild(modalBackdrop);

            const selectAll = modalBackdrop.querySelector('#select-all-groups');
            const groupCheckboxes = modalBackdrop.querySelectorAll('.group-select-checkbox');
            selectAll.addEventListener('change', () => {
                groupCheckboxes.forEach(cb => cb.checked = selectAll.checked);
            });
            groupCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    selectAll.checked = [...groupCheckboxes].every(c => c.checked);
                });
            });

            modalBackdrop.querySelector('#confirm-export').addEventListener('click', () => {
                const selectedGroups = [...groupCheckboxes].filter(cb => cb.checked).map(cb => cb.value);
                exportSummaryToPng(selectedGroups);
                modalBackdrop.classList.remove('visible');
                setTimeout(() => modalBackdrop.remove(), 300);
            });

            const closeModal = () => {
                modalBackdrop.classList.remove('visible');
                setTimeout(() => modalBackdrop.remove(), 300);
            };
            modalBackdrop.querySelector('#cancel-export').addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', (e) => {
                if(e.target === modalBackdrop) closeModal();
            });

            setTimeout(() => modalBackdrop.classList.add('visible'), 10);
        };
        
        const exportSummaryToPng = (selectedGroups) => {
            const exportContainer = document.createElement('div');
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-9999px';
            exportContainer.style.padding = '20px';
            exportContainer.style.backgroundColor = 'var(--background-main)';
            exportContainer.style.width = '800px';
            document.body.appendChild(exportContainer);

            try {
                const title = document.createElement('h2');
                title.innerText = 'สรุปแผนการทำงานล่วงเวลา (OT Plan Summary)';
                title.style.textAlign = 'center';
                title.style.color = 'var(--primary-color)';
                exportContainer.appendChild(title);
                
                const summaryClone = planSummaryContainer.cloneNode(true);
                summaryClone.querySelectorAll('.group-summary-block').forEach(block => {
                    if (!selectedGroups.includes(block.dataset.summaryGroup)) {
                        block.remove();
                    }
                });
                exportContainer.appendChild(summaryClone);

                const budgetClone = budgetStatusContainer.cloneNode(true);
                exportContainer.appendChild(budgetClone);

                html2canvas(exportContainer, { scale: 2, useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `OT_Summary_Report_${selectedGroups.join('-')}_${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }).catch(err => {
                    console.error("PNG Export failed:", err);
                    alert("เกิดข้อผิดพลาดในการสร้างไฟล์รูปภาพ กรุณาลองใหม่อีกครั้ง");
                });
            } catch (error) {
                console.error("Error preparing PNG content:", error);
                alert("เกิดข้อผิดพลาดในการเตรียมข้อมูลสำหรับ Export");
            } finally {
                if (document.body.contains(exportContainer)) {
                    document.body.removeChild(exportContainer);
                }
            }
        };

        // --- START APP ---
        initApp();
    });
</script>
</body>
</html>